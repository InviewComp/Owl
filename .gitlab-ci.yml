image: gitlab/dind

services:
  - docker:dind

stages:
  - test
  - build
    #  - deploy_1
  - deploy_2
    #  - deploy_3

before_script:
  - docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}

    #build collector:
    #  stage: build
    #  script:
    #    - docker build -t ${DOCKER_TEAM}/owl-collector ./collector
    #    - docker push ${DOCKER_TEAM}/owl-collector
    #  only:
    #    changes:
    #      - collector/* 

    #test worker:
    #
    #  stage: test
    #  script:
    #    - cd worker/
    #    - docker run --rm -v $(pwd):/app -w /app golangci/golangci-lint:v1.24.0 golangci-lint run -v
    #  only:
    #    changes:
    #      - worker/worker.go

    #test collector:
    #  stage: test
    #  script:
    #    - cd collector/
    #    - docker run --rm -v $(pwd):/app -w /app golangci/golangci-lint:v1.24.0 golangci-lint run -v
    #  only:
    #    changes:
    #      - collector/collector.go 

build worker:
  stage: build
  tags:
    - docker
  image:
    name: gitlab/dind
  script:
    - docker build -t ${DOCKER_TEAM}/owl-worker ./worker
    - docker push ${DOCKER_TEAM}/owl-worker
  only:
    changes:
      - worker/*

        #build analyzer:
        #  stage: build
        #  script:
        #    - docker build -t ${DOCKER_TEAM}/owl-analyzer ./metric_analyze
        #    - docker push ${DOCKER_TEAM}/owl-analyzer
        #  only:
        #    changes:
        #      - metric_analyze/*

#build opcuaserver:
  #stage: build
  #script:
    #- docker build -t ${DOCKER_TEAM}/opc-server ./opc_ua_server
    #- docker push ${DOCKER_TEAM}/opc-server
  #only:
    #changes:
      #- opc_ua_server/*

        #deploy rabbitmq:
        #  stage: deploy_1
        #  script:
        #    - kubectl delete -f rabbitmq.yaml
        #    - kubectl create -f rabbitmq.yaml  
        #  only:
        #    changes:
        #      - rabbitmq*

        #deploy clickhouse:
        #  stage: deploy_1
        #  script:
        #    - kubectl delete -f clickhouse.yaml
        #    - kubectl create -f clickhouse.yaml             
        #  only:
        #    changes:
        #      - clickhouse.yaml

#deploy opcuaserver:
  #stage: deploy_1
  #script:
    #- kubectl delete -f ./opc_ua_server/opc.yaml
    #- kubectl create -f ./opc_ua_server/opc.yaml
  #only:
    #changes:
      #- opc_ua_server/*

        #deploy collector:
        #  stage: deploy_2
        #  image: alpine:3.7
        #  script:
        #    - apk update  && apk add --no-cache curl docker
        #    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
        #    - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
        #    - mkdir -p $HOME/.kube
        #    - echo -n $KUBE_CONFIG | base64 -d > $HOME/.kube/config
        #    - kubectl config view
        #    - kubectl delete -f ./collector/collector.yaml
        #    - kubectl create -f ./collector/collector.yaml 
        #  only:
        #    changes:
        #      - collector/*

deploy worker:
  stage: deploy_2
  tags:
    - k8s
  image:
    name: lachlanevenson/k8s-kubectl:latest
    entrypoint: ["/bin/sh", "-c"]
  script:
    - apt-get -y install curl
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    - mkdir -p $HOME/.kube
    - echo -n $KUBE_CONFIG | base64 -d > $HOME/.kube/config
    - kubectl config view
    - kubectl delete -f ./worker.yaml
    - kubectl create -f ./worker.yaml  
  only:
    changes:
      - worker/*

        #deploy analyzer:
        #  stage: deploy_3
        #  image: alpine:3.7
        #  script:
        #    - apk update  && apk add --no-cache curl docker
        #    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
        #    - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
        #    - mkdir -p $HOME/.kube
        #    - echo -n $KUBE_CONFIG | base64 -d > $HOME/.kube/config
        #    - kubectl config view
        #    - kubectl delete -f ./metric_analyze/analyzer.yaml
        #    - kubectl create -f ./metric_analyze/analyzer.yaml
        #  only:
        #    changes:
        #      - metric_analyze/*
