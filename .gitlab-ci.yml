image: gitlab/dind

services:
  - docker:18.09.7-dind

stages:
  - build
  - deploy

build worker:
  stage: build
  tags:
    - docker
  image:
    name: gitlab/dind
  script:
    - docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
    - docker build -t ${DOCKER_TEAM}/owl-worker ./worker
    - docker push ${DOCKER_TEAM}/owl-worker

deploy worker:
  stage: deploy
  tags:
    - kubernetes
  image:
    name: gitlab/dind
  script:
    - apt-get -y install curl
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    - curl -O https://dl.google.com/go/go1.13.linux-amd64.tar.gz
    - tar -xvf go1.13.linux-amd64.tar.gz
    - mv go /usr/local
    - export GOPATH=$HOME
    - export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin
    - go version
    - export GO111MODULE="on"
    - curl -Lo ./kind https://github.com/kubernetes-sigs/kind/releases/download/v0.7.0/kind-$(uname)-amd64
    - chmod +x ./kind
    - sudo ./kind create cluster
    - kubectl config view
    - kubectl delete -f ./worker.yaml
    - kubectl create -f ./worker.yaml  
