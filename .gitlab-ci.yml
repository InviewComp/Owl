image: gitlab/dind

variables:
  KUBECTL: v1.17.0
  KIND: v0.7.0

services:
  - docker:18.09.7-dind

stages:
  - build
  - deploy

build worker:
  stage: build
  tags:
    - docker
  image:
    name: gitlab/dind
  script:
    - docker login -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
    - docker build -t ${DOCKER_TEAM}/owl-worker ./worker
    - docker push ${DOCKER_TEAM}/owl-worker

deploy worker:
  stage: deploy
  tags:
    - kubernetes
  image:
    name: docker:stable
  script:
    - apt-get -y install wget
    - wget -O /usr/local/bin/kind https://github.com/kubernetes-sigs/kind/releases/download/${KIND}/kind-linux-amd64
    - chmod +x /usr/local/bin/kind
    - wget -O /usr/local/bin/kubectl https://storage.googleapis.com/kubernetes-release/release/${KUBECTL}/bin/linux/amd64/kubectl
    - chmod +x /usr/local/bin/kubectl
    - kind create cluster --config=./gitlab/kind-config.yaml
    - sed -i -E -e 's/localhost|0\.0\.0\.0/docker/g' "$HOME/.kube/config"
    - kubectl delete -f ./worker/worker.yaml
    - kubectl create -f ./worker/worker.yaml

